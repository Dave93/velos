name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  ZIG_VERSION: "0.15.2"

jobs:
  build:
    name: Build ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: velos-linux-x86_64
            cross: false
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: velos-linux-arm64
            cross: true
          - target: x86_64-apple-darwin
            os: macos-13
            name: velos-macos-x86_64
            cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            name: velos-macos-arm64
            cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # For ARM64 Linux cross-compilation, install cross-compilation toolchain
      - name: Install cross-compilation tools (ARM64 Linux)
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          echo '[target.aarch64-unknown-linux-gnu]' >> ~/.cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml

      - name: Build Zig core
        run: cd zig && zig build -Doptimize=ReleaseFast

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Strip binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/velos || true
          else
            strip target/${{ matrix.target }}/release/velos || true
          fi

      - name: Package as tar.gz
        run: |
          mkdir -p dist/${{ matrix.name }}
          cp target/${{ matrix.target }}/release/velos dist/${{ matrix.name }}/velos
          cd dist
          tar czf ${{ matrix.name }}.tar.gz ${{ matrix.name }}/
          rm -rf ${{ matrix.name }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/${{ matrix.name }}.tar.gz

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz > checksums.txt
          cat checksums.txt

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

  upload-r2:
    name: Upload to Cloudflare R2
    needs: release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, '-') }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz > checksums.txt

      - name: Configure AWS CLI for R2
        run: |
          aws configure set aws_access_key_id "${{ secrets.R2_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          aws configure set default.region auto

      - name: Extract version
        id: version
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Upload to R2 (versioned)
        env:
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          VERSION="${{ steps.version.outputs.tag }}"

          # Upload versioned artifacts
          for file in artifacts/*.tar.gz; do
            aws s3 cp "$file" "s3://${R2_BUCKET}/${VERSION}/$(basename "$file")" \
              --endpoint-url "$R2_ENDPOINT" \
              --content-type "application/gzip"
          done

          # Upload checksums
          aws s3 cp artifacts/checksums.txt "s3://${R2_BUCKET}/${VERSION}/checksums.txt" \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "text/plain"

      - name: Upload to R2 (latest)
        env:
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          # Copy to latest/
          for file in artifacts/*.tar.gz; do
            aws s3 cp "$file" "s3://${R2_BUCKET}/latest/$(basename "$file")" \
              --endpoint-url "$R2_ENDPOINT" \
              --content-type "application/gzip"
          done

          aws s3 cp artifacts/checksums.txt "s3://${R2_BUCKET}/latest/checksums.txt" \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "text/plain"

      - name: Upload install script to R2
        env:
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          R2_BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          aws s3 cp distribution/install.sh "s3://${R2_BUCKET}/install.sh" \
            --endpoint-url "$R2_ENDPOINT" \
            --content-type "text/plain"
